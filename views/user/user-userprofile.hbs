<section id="page-title" class="page-title">
    <div class="my-account-area">
        <div class="container">
            <div class="row">
                {{>user-ordersnav}}
                <div class="col-md-9">
                    <div class="personal-information">
                        <h4 class="my-account-title">Personal information</h4>

                        <div class="personal-information-box">
                            <div class="row">
                                {{!-- The form to submit --}}
                                <form action="/edituserprofile/{{user._id}}" method="post" enctype="multipart/form-data" id="editProfile">

                                    {{!-- Profile Image --}}
                                    <div class="img__wrap">
                                        
                                        <img class="img__img" src="/profileImages/{{user._id}}1.jpg" height="150px" id="imgview1" />
                                        <label  class="img__description" id="edit_img" for="profileimage"><h5 class="editText"><i class="bi bi-pencil"></i>  Edit</h5></label>
                                        <input type="file" data-toggle="modal" name="profileImage" id="profileimage" onchange="return fileValidation1()">
                                        <div id="errMess1"></div>
                                    </div>

                                    {{!-- Modal for image croping --}}

                                        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalLabel">Crop Image</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="col-12">
                                                            <div style="width: 300px; height: auto; display: none;" id="image-box"></div>
                                                            
                                                            <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                                                            <button style="display: none;" class="btn btn-danger mt-4" type="button" id="crop-btn" data-dismiss="modal"  style="float: right;">Crop</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    {{!-- Modal for image croping Ends--}}

                                    {{!-- Profile Image ends --}}

                                    <div class="col-md-6 col-xs-12">

                                        <div class="pib-item">
                                            <label>First Name</label>
                                            <input type="text" name="firstname" value="{{user.firstname}}"
                                                placeholder="Enter your first name...">
                                        </div>
                                        <div class="pib-item">
                                            <label>Email</label>
                                            <input type="text" name="email" value="{{user.email}}"
                                                placeholder="Enter your mail...">
                                        </div>
                                        <div class="pib-item">
                                            <label>Address</label>
                                            <input type="text" name="address1" value="{{user.address1}}"
                                                placeholder="Enter your address...">
                                        </div>
                                        <div class="pib-item">
                                            <label>Country</label>
                                            <select id="country" name="country">
                                                <option>select country</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-6 col-xs-12">
                                        <div class="pib-item">
                                            <label>Last Name</label>
                                            <input type="text" name="lastname" value="{{user.lastname}}"
                                                placeholder="Enter your last name...">
                                        </div>
                                        <div class="pib-item">
                                            <label>Phone Number</label>
                                            <input type="text" name="mobile" value="{{user.mobile}}"
                                                placeholder="Enter your phone number...">
                                        </div>
                                        <div class="pib-item">
                                            <label>address 2</label>
                                            <input type="text" name="address2" value="{{user.address2}}"
                                                placeholder="Enter the apartment. floor, suite, etc...">
                                        </div>
                                        <div class="pib-item pib-item-state-zip">
                                            <div class="row">
                                                <div class="col-md-6 col-xs-12">

                                                    <label for="state">State</label>
                                                    <span id="state-code">
                                                        <input type="text" name="state" value="{{user.state}}" id="state">
                                                    </span>

                                                </div>
                                                <div class="col-md-6 col-xs-12">
                                                    <label>Zip Code</label>
                                                    <input type="text" name="pincode" value="{{user.pincode}}"
                                                        placeholder="Enter your Zip code...">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="pib-item pib-item-date">
                                            <label>Secondary Phone</label>
                                            <input type="text" name="secondphone" value="{{user.secondphone}}"
                                                placeholder="Enter your phone number...">
                                       
                                        </div>
                                    </div>
                                    <div class="col-xs-12">
                                        <div class="pib-save-change">
                                            <a href="/forgotpassword " class="btn btn-secondary">Reset Password</a>
                                            <a class="btn btn-primary" data-toggle="modal" id="confirm-btn" data-target="#{{this.user._id}}">Save all changes</a>
                                        </div>
                                    </div>

                                    <div class="modal fade" id="{{this.user._id}}" tabindex="-1" role="dialog"
                                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h3 class="modal-title" style="color: red;" id="exampleModalLabel">
                                                        EDIT PROFILE</h3>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <h5>Are you sure you want to make changes ?</h5>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-success"
                                                        data-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary"
                                                        style="width: 90px;">Edit</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </form> 

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.11/cropper.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.11/cropper.js"></script>

<script>
    $(document).ready(function () {
        $('#editProfile').validate({
            rules : {
                firstname :{
                    required :true,
                    alpha :true,
                },
                email :{
                    required : true,
                    email : true,
                },
                address1 :{
                    required : true,
                },
                country : {
                    required : true,
                },
                lastname : {
                    required :true,
                },
                mobile : {
                    required : true,
                    minlength : 10
                    maxlength : 10,
                    digits : true,
                },
                address2  :{
                    required : true,   
                },
                state : {
                    required  :true,
                },
                pincode : {
                    required  :true,
                    minlength :6,
                    maxlength : 6,
                    digits : true,
                },
                secondphone : {
                    minlength : 10,
                    maxlength : 10,
                    digits :true,
                }
            }
        })
    })
</script>

<script>
    function fileValidation1() {
            const imagebox = document.getElementById('image-box')
            const crop_btn = document.getElementById('crop-btn')
            var fileInput = document.getElementById('profileimage');

            var filePath = fileInput.value;
            var allowedExtensions = /(\.jpg)$/i;
            if (!allowedExtensions.exec(filePath)) {
                document.getElementById('errMess1').innerHTML = '<p style="color:red; display: block;">Invalid file type</p>'
                document.getElementById('image-box ').style.display = 'none'
                fileInput.value = '';
                return false;
            } else {
                document.getElementById('errMess1').innerHTML = ''

                var fileTrue = document.getElementById('profileimage').onchange.length
                if(fileTrue == 1){
                    document.getElementById('profileimage').dataset.target = '#exampleModal'
                    document.getElementById('profileimage').click()
                    fileTrue = 0
                }
                document.getElementById('profileimage').dataset.target = 'none'

                //Image preview
                const img_data = fileInput.files[0]
                const url = URL.createObjectURL(img_data)
                imagebox.innerHTML = `<img src="${url}" id="image" style="width:100%">`
                const image = document.getElementById('image')
                document.getElementById('image-box').style.display = 'block'
                document.getElementById('crop-btn').style.display = ''
                document.getElementById('confirm-btn').style.display = 'block'

                const cropper = new Cropper(image, {
                    autoCropArea: 1,
                    viewMode: 1,
                    scalable: false,
                    zoomable: true,
                    movable: false,
                    aspectRatio: 0.75 / 1,
                    //  preview: '.preview',
                    minCropBoxWidth: 180,
                    minCropBoxHeight: 240,
                })
                crop_btn.addEventListener('click', () => {
                    cropper.getCroppedCanvas().toBlob((blob) => {
                        let fileInputElement = document.getElementById('profileimage');
                        let file = new File([blob], img_data.name, { type: "image/*", lastModified: new Date().getTime() });
                        let container = new DataTransfer();

                        container.items.add(file);
                        const img = container.files[0]
                        var url = URL.createObjectURL(img)
                        fileInputElement.files = container.files;
                        document.getElementById('imgview1').src = url
                        document.getElementById('image-box').style.display = 'none'
                        document.getElementById('crop-btn').style.display = 'none'
                        document.getElementById('confirm-btn').style.display = 'block'
                    });
                });
            }
        }
</script>

<script>
    // user country code for selected option
    let user_country_code = "IN";

    (function () {
        // script https://www.html-code-generator.com/html/drop-down/country-region

        // Get the country name and state name from the imported script.
        let country_list = country_and_states['country'];
        let states_list = country_and_states['states'];

        // creating country name drop-down
        let option = '';
        option += '<option>select country</option>';
        for (let country_code in country_list) {
            // set selected option user country
            let selected = (country_code == user_country_code) ? ' selected' : '';
            option += '<option value="' + country_code + '"' + selected + '>' + country_list[country_code] + '</option>';
        }
        document.getElementById('country').innerHTML = option;

        // creating states name drop-down
        let text_box = '<input type="text" class="input-text" id="state">';
        let state_code_id = document.getElementById("state-code");

        function create_states_dropdown() {
            // get selected country code
            let country_code = document.getElementById("country").value;
            let states = states_list[country_code];
            // invalid country code or no states add textbox
            if (!states) {
                state_code_id.innerHTML = text_box;
                return;
            }
            let option = '';
            if (states.length > 0) {
                option = '<select id="state">\n';
                for (let i = 0; i < states.length; i++) {
                    option += '<option value="' + states[i].code + '">' + states[i].name + '</option>';
                }
                option += '</select>';
            } else {
                // create input textbox if no states 
                option = text_box
            }
            state_code_id.innerHTML = option;
        }

        // country select change event
        const country_select = document.getElementById("country");
        country_select.addEventListener('change', create_states_dropdown);

        create_states_dropdown();
    })();
</script>
<style>
    .modal-body .btn {
    height: 35px;
    border-radius: 2px;
    margin-bottom: 0px;
    font-weight: 700;
    margin-top: 30px;
}
    #imgview1{
        border-radius: 10px;
    }
    .editText{
    color: #fff;
    margin-top: 60px;
    margin-left: 30px;
    cursor: pointer;
}
 
    input[type="file"] {
        display: none;
    }

    #edit_img {
        margin-left: 0px;
        color: white;
        font-size: large;
    }

    * {
        margin: 0;
        padding: 0;
        border: 0;
    }

    /* relevant styles */
    .img__wrap {
        position: relative;
        height: 180px;
        width: 150px;
        border-radius: 100px;
    }

    .img__description {
        border-radius: 10px;
    position: absolute;
    top: 0px;
    bottom: 25px;
    left: -1px;
    right: 0;
    justify-content: center;
    width: 114px;
    background: #000000b8;
    border-radius: 10px;
    color: #fff;
    visibility: hidden;
    opacity: 0;

        /* transition effect. not necessary */
        transition: opacity .2s, visibility .2s;
    }

    .img__wrap:hover .img__description {
        visibility: visible;
        opacity: 1;
    }

    .my-account-area {
        padding: 54px 0 120px;
    }

    .my-account-title {
        color: #555555;
        font-size: 18px;
        letter-spacing: 0;
        margin: 0 0 23px;
        position: relative;
        text-transform: uppercase;
    }

    .my-account-title::after {
        background: #ed1d7f none repeat scroll 0 0;
        bottom: -22px;
        content: "";
        height: 3px;
        left: 0;
        position: absolute;
        width: 30px;
        z-index: 2;
    }

    .my-account-welcome {}

    .my-account-welcome ul {
        list-style: outside none none;
        padding: 0;
    }

    .my-account-welcome ul li {}

    .my-account-welcome ul li a {
        color: #555555;
        font-size: 15px;
        font-weight: 300;
        letter-spacing: 0;
        line-height: 72px;
    }

    .personal-information {}

    .personal-information-box {
        margin: 51px 0 0;
    }

    .pib-item {
        margin: 0 0 28px;
    }

    .pib-item label {
        color: #555555;
        display: block;
        font-size: 15px;
        font-weight: 300;
        letter-spacing: 0;
        line-height: 17px;
        margin: 0 0 17px;
        text-transform: capitalize;
    }

    .pib-item input[type="text"],
    .pib-item select {
        border: 1px solid #dddddd;
        color: #b7b7b7;
        font-size: 14px;
        font-weight: 300;
        height: 50px;
        letter-spacing: 0;
        padding: 0 10px;
        width: 100%;
    }

    .pib-item.pib-item-date select {
        display: inline-block;
        margin-left: 3.3%;
        width: 30%;
    }

    .pib-item.pib-item-date select.bd-month {
        margin-left: 0;
    }

    .pib-item.pib-item-date select.bd-date {}

    .pib-item.pib-item-date select.bd-year {}

    .pib-save-change {
        margin: 32px 0 0;
        text-align: right;
    }

    .pib-save-change button {
        background: #ed1d1d none repeat scroll 0 0;
        border: 0 none;
        border-radius: 3px;
        color: #fff;
        display: inline-block;
        font-size: 14px;
        letter-spacing: 0;
        padding: 5px 30px;
        text-transform: uppercase;
    }
</style>